---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}

library(plyr)
library(dplyr)
library(kableExtra)
library(gmodels)
library(reshape)
library(tidyr)
library(knitr)
library(plotly)
if (!require("processx")) install.packages("processx")
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

color_csv<-read.csv(file = "../../csv/csv_report_color.csv", skip='0', sep = ";", header = FALSE)
report <- read.csv(file = "../../csv/csv_report.csv", skip='0', sep = ";", header = FALSE)
elements<-read.csv(file = "../../csv/csv_report_elements.csv", skip='0', sep = ";", header = FALSE)

colnames(color_csv) <- c("filename","project_id", "diagram_id","element_type","color","url")
colnames(elements)<- c("project_id","diagram_id","element_id","type","name","in_class","asso_type","visibility","format", "begin_format")
colnames(report)<- c("filename","project_id","diagram_id","nb_class","grid_lines","grid_columns","grid_ratio","width","height","true_width","true_height","max_elt_in_class","nb_intersect","nb_links","max_link_for_class","diagram_url")


elements <- elements %>% filter(type != "", !grepl(" ", type, fixed = TRUE))
elements <- elements %>% filter(format %in% c('camel_case', 'snake_case', 'uppercase', 'with_spaces'))
elements <- elements %>% filter(!grepl("undefined", begin_format, fixed = TRUE))


report <- report %>% filter(nb_class > 0, nb_class < 100)



colors_by_diagram <- color_csv %>% group_by(project_id, element_type) %>% tally()
analysis_elements <- elements %>% group_by(diagram_id, type) %>% tally()
type_of_elements <- elements %>% group_by(type) %>% tally()


```

# Total elements
```{r}
temp <- elements %>% group_by(type) %>% tally() %>% mutate(formatted = format(round(as.numeric(n), 1), nsmall=0, big.mark=",", trim = TRUE)) %>% arrange(desc(n)) %>% ungroup()
fig <- plot_ly(temp, x = ~type, y = ~n, name = "SF Zoo",type = "bar", textposition = 'outside', textangle="-45", text = ~formatted#,marker = list(color = 'rgb(158,202,225)',line = list(color = 'rgb(8,48,107)', width = 1.5))
             ) %>% 
  layout( title = "UML elements in diagrams", xaxis = list(categoryorder = "array", categoryarray = ~n), yaxis =list(range=c(0,2200000))
  )

write.csv(temp,"generated_csv/total_elements.csv", row.names = TRUE)

fig <- fig %>% layout(uniformtext=list(minsize=12, mode = "show"))

fig

```

# Number of Formatting
```{r}
temp <- elements %>% filter(!grepl("enumeration", type, fixed = TRUE)) %>% group_by(project_id, diagram_id, format) %>% tally() %>% group_by(project_id, diagram_id) %>% summarize(nb_format = n()) %>% group_by(nb_format) %>% tally()

fig <- plot_ly(temp, x = ~nb_format, y = ~n, name = "SF Zoo",type = "bar", textposition = 'outside', textangle="-45", text = ~n) %>% 
  layout(title = "UML elements in diagrams", xaxis = list(categoryorder = "array", categoryarray = ~n))

fig <- fig %>% layout(uniformtext=list(minsize=12, mode = "show"))

write.csv(temp,"generated_csv/number_of_formatting.csv", row.names = TRUE)


fig

```

# Format
```{r}
nb_elts <- elements %>% group_by(type) %>% summarize(total_elt = n()) 

temp <- full_join(elements, nb_elts, "type") %>% group_by(type, format, total_elt) %>% tally() %>% mutate(ratio = 100*n/total_elt)

fig <- plot_ly(temp, x = ~type, y = ~ratio, color = ~format,type = "bar", textposition = 'outside') %>% 
  layout(title = "UML elements in diagrams", xaxis = list(categoryorder = "array", categoryarray = ~n), barmode = 'stack')

write.csv(temp,"generated_csv/formating_distribution_by_element.csv", row.names = TRUE)


fig

```

# Begin Maj
```{r}
nb_elts <- elements %>% group_by(type) %>% summarize(total_elt = n()) 

temp <- full_join(elements, nb_elts, "type") %>% group_by(type, begin_format, total_elt) %>% tally() %>% mutate(ratio = 100*n/total_elt)

fig <- plot_ly(temp, x = ~type, y = ~ratio, color = ~begin_format,type = "bar", textposition = 'outside') %>% 
  layout(title = "UML elements in diagrams", xaxis = list(categoryorder = "array", categoryarray = ~n), barmode = 'stack')

write.csv(temp,"generated_csv/uppercase_begin_distribution_by_element.csv", row.names = TRUE)


fig

```

# Nb couleurs
```{r}
nb_elts <- color_csv %>% group_by(project_id, diagram_id, color, url) %>% tally()%>% group_by(project_id, diagram_id, url) %>% summarize(nb_color = n()) %>% group_by(nb_color) %>% tally()

fig <- plot_ly(nb_elts, x = ~nb_color, y = ~n,type = "bar", textposition = 'outside') %>% 
  layout(title = "UML elements in diagrams", xaxis = list(categoryorder = "array", categoryarray = ~n))

write.csv(nb_elts,"generated_csv/color_number_in_diagrams.csv", row.names = TRUE)

fig

```
# Elts colores
```{r}
nb_elts <- color_csv %>% group_by(element_type) %>% tally() %>% arrange(desc(n))

fig <- plot_ly(nb_elts, x = ~element_type, y = ~n,type = "bar", textposition = 'outside') %>% 
  layout(title = "UML elements in diagrams", xaxis = list(categoryorder = "array", categoryarray = ~n))

write.csv(nb_elts,"generated_csv/element_distribution.csv", row.names = TRUE)

fig

```

#Color en fonction de nb class
```{r}
nb_elts <- color_csv %>% group_by(project_id, diagram_id, color, url) %>% tally()%>% group_by(project_id, diagram_id, url) %>% summarize(nb_color = n(), identifiant = paste(project_id, diagram_id)) %>% ungroup()
nb_elts <- nb_elts %>% distinct(identifiant, nb_color)
report_augmented <- report %>% mutate(identifiant = paste(project_id, diagram_id))

elts_total <- left_join(report_augmented, nb_elts, "identifiant")

elts_total <- elts_total %>% filter(!is.na(nb_color)) %>% group_by(nb_class) %>% summarize(mean_color = mean(nb_color))

fig <- plot_ly(elts_total, x = ~nb_class, y = ~mean_color)

fig

```

#Color en fonction de la classe
```{r}


nb_elts <- color_csv %>% group_by(project_id, diagram_id, color, url) %>% tally()%>% group_by(project_id, diagram_id, url) %>% summarize(nb_color = n(), identifiant = paste(project_id, diagram_id)) %>% ungroup()
nb_elts <- nb_elts %>% distinct(identifiant, nb_color)
report_augmented <- report %>% mutate(identifiant = paste(project_id, diagram_id))

elts_total <- left_join(report_augmented, nb_elts, "identifiant")

elts_total <- elts_total %>% replace_na(list(nb_color=0)) %>% mutate(has_color = nb_color > 0) %>% group_by(nb_class, has_color) %>% tally() %>% full_join(nb_diags, "nb_class") %>% mutate(ratio = n/total_diag)

fig <- plot_ly(elts_total, x = ~nb_class, y = ~ratio, color = ~has_color,type = "bar", textposition = 'outside') %>% 
  layout(title = "UML elements in diagrams", xaxis = list(categoryorder = "array", categoryarray = ~n), barmode = 'stack')

write.csv(elts_total,"generated_csv/colored_ratio_by_class.csv", row.names = TRUE)


fig

```

#Color top1
```{r}

nb_elts <- color_csv %>% group_by(project_id, diagram_id, color, url) %>% tally() %>% arrange(color) %>% group_by(project_id, diagram_id, url) %>% summarize(nb_color = n(), colors = paste0(color, collapse = " ") , identifiant = paste(project_id, diagram_id)) %>% distinct() %>% group_by(colors, nb_color) %>% summarize(total = n()) %>% arrange(nb_color, desc(total)) %>% group_by(nb_color) %>% slice_max(total, n = 3)

```

# Total diagrams / nb class
```{r}
nb_elts <- report %>% group_by(nb_class) %>% tally()

fig <- plot_ly(nb_elts, x = ~nb_class, y = ~n,type = "bar") 
write.csv(nb_elts,"generated_csv/nb_class.csv", row.names = TRUE)

fig

```

# Total diagrams / nb links
```{r}
nb_elts <- report %>% group_by(nb_links) %>% tally()

fig <- plot_ly(nb_elts, x = ~nb_links, y = ~n,type = "bar") 
write.csv(nb_elts,"generated_csv/nb_elts.csv", row.names = TRUE)

fig

```

# Intersect vs links
```{r}
nb_elts <- report %>% group_by(nb_links) %>% filter(nb_intersect < 50) %>% summarize(mean_inter = mean(nb_intersect)) 
write.csv(nb_elts,"generated_csv/intersect_by_links.csv", row.names = TRUE)

fig <- plot_ly(nb_elts, x = ~nb_links, y = ~mean_inter)

fig

```

# Links vs class
```{r}
nb_elts <- report %>% filter(nb_class < 100) %>% group_by(nb_class) %>% summarize(mean_links = mean(nb_links)) 

fig <- plot_ly(nb_elts, x = ~nb_class, y = ~mean_links)
write.csv(nb_elts,"generated_csv/links_by_class", row.names = TRUE)

fig

```
# max connect vs nb_class
```{r}
nb_elts <- report %>% filter(nb_class < 100) %>% group_by(nb_class) %>% summarize(mean_max_connect = mean(max_link_for_class)) 

fig <- plot_ly(nb_elts, x = ~nb_class, y = ~mean_max_connect)
write.csv(nb_elts,"generated_csv/mean_max_connect_by_class", row.names = TRUE)

fig

```

# max elt in class vs nb_class
```{r}
nb_elts <- report %>% filter(nb_class < 100) %>% group_by(nb_class) %>% summarize(max_elt = mean(max_elt_in_class)) 

fig <- plot_ly(nb_elts, x = ~nb_class, y = ~max_elt)

fig

```